<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Starship Defender - Audio & Evolution</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; color: #00ffcc; }
        canvas { display: block; }
        #startScreen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column;
            justify-content: flex-start; align-items: flex-start;
            padding-left: 10%; padding-top: 12vh; z-index: 10;
        }
        #startButton {
            padding: 25px 50px; width: 450px; font-size: 32px; background: transparent;
            color: #00ffcc; border: 3px solid #00ffcc; cursor: pointer;
            transition: 0.3s; margin-bottom: 25px; text-transform: uppercase; font-weight: bold;
        }
        #startButton:hover { background: #00ffcc; color: #000; box-shadow: 0 0 30px #00ffcc; }
        .score-box {
            padding: 15px 30px; width: 315px; font-size: 20px; color: #fff;
            border: 2px solid rgba(0, 255, 204, 0.5); margin-bottom: 15px;
            text-align: center; background: rgba(0, 40, 40, 0.3); font-weight: bold;
        }
        #gameUI {
            position: absolute; top: 25px; left: 25px; background: rgba(0, 40, 40, 0.85);
            padding: 20px; border: 2px solid #00ffcc; border-radius: 10px; display: none; pointer-events: none;
        }
        #gameUI div { font-size: 22px; margin-bottom: 8px; font-weight: bold; }
        .label { color: #888; font-size: 14px; display: block; }
    </style>
</head>
<body>

    <div id="startScreen">
        <button id="startButton">YENİ OYUNA BAŞLA</button>
        <div class="score-box">EN İYİ SKOR: <span id="highScoreText">0</span></div>
        <div class="score-box">EN SON SKOR: <span id="lastScoreText">0</span></div>
    </div>

    <div id="gameUI">
        <div style="color: #00ffcc; border-bottom: 1px solid #00ffcc; margin-bottom: 10px;">KOMUTA PANELİ</div>
        <div><span class="label">SKOR</span> <span id="skor" style="color: #fff;">0</span></div>
        <div><span class="label">SIVI SEVİYESİ</span> <span id="zirh" style="color: #0f0;">%100</span></div>
        <div><span class="label">LAZER ÜNİTESİ</span> <span id="lazerSarj" style="color: #0ff;">%0</span></div>
    </div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('startScreen');
        const startButton = document.getElementById('startButton');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let highScore = localStorage.getItem('highScore') || 0;
        let lastScore = localStorage.getItem('lastScore') || 0;
        document.getElementById('highScoreText').innerText = highScore;
        document.getElementById('lastScoreText').innerText = lastScore;

        let gameActive = false;
        let skor = 0;
        let zirh = 100;
        let lazerSarj = 0;
        const keys = {};
        let mermiler = [];
        let dusmanlar = [];
        let puanlar = [];
        let saglikCantalar = [];

        // WEB AUDIO API - Silah Sesi Fonksiyonu
        function playGunSound() {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const primaryGain = audioCtx.createGain();
            primaryGain.connect(audioCtx.destination);

            const bufferSize = audioCtx.sampleRate * 0.1;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) { data[i] = Math.random() * 2 - 1; }

            const noise = audioCtx.createBufferSource();
            noise.buffer = buffer;

            const noiseFilter = audioCtx.createBiquadFilter();
            noiseFilter.type = 'lowpass';
            noiseFilter.frequency.setValueAtTime(1000, audioCtx.currentTime);
            noiseFilter.frequency.exponentialRampToValueAtTime(10, audioCtx.currentTime + 0.05);

            const noiseEnvelope = audioCtx.createGain();
            noiseEnvelope.gain.setValueAtTime(1.5, audioCtx.currentTime);
            noiseEnvelope.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

            noise.connect(noiseFilter);
            noiseFilter.connect(noiseEnvelope);
            noiseEnvelope.connect(primaryGain);

            const oscillator = audioCtx.createOscillator();
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.05);

            const oscEnvelope = audioCtx.createGain();
            oscEnvelope.gain.setValueAtTime(0.5, audioCtx.currentTime);
            oscEnvelope.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);

            oscillator.connect(oscEnvelope);
            oscEnvelope.connect(primaryGain);

            noise.start(); oscillator.start();
            noise.stop(audioCtx.currentTime + 0.1); oscillator.stop(audioCtx.currentTime + 0.1);
        }

        window.addEventListener('keydown', e => keys[e.code] = true);
        window.addEventListener('keyup', e => keys[e.code] = false);

        const gemi = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            aci: 0,
            yariCap: 22,
            baseNormalHiz: 1.15,
            baseTurboHiz: 2.1,
            donusHizi: 0.022, 
            
            draw(scale = 1) {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.scale(scale, scale);

                let kademe = Math.ceil((zirh / 100) * 15);
                kademe = Math.max(1, Math.min(15, kademe));
                let hue = (kademe / 15) * 120;
                let siviRengi = `hsl(${hue}, 100%, 40%)`;

                ctx.beginPath();
                ctx.arc(0, 0, this.yariCap, 0, Math.PI * 2);
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.save();
                ctx.beginPath();
                ctx.arc(0, 0, this.yariCap - 2, 0, Math.PI * 2);
                ctx.clip(); 
                let dolulukYuksekligi = this.yariCap - ((kademe / 15) * (this.yariCap * 2));
                ctx.fillStyle = siviRengi;
                ctx.fillRect(-this.yariCap, dolulukYuksekligi, this.yariCap * 2, this.yariCap * 2);
                ctx.restore();

                if (gameActive) {
                    ctx.rotate(this.aci);
                    ctx.beginPath();
                    ctx.moveTo(this.yariCap + 12, 0);   
                    ctx.lineTo(this.yariCap + 32, 0);   
                    ctx.lineTo(this.yariCap + 22, 8);
                    ctx.lineTo(this.yariCap + 22, -8);
                    ctx.lineTo(this.yariCap + 32, 0);
                    ctx.fillStyle = '#00ffcc';
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.stroke();
                }
                ctx.restore();
            }
        };

        function update() {
            if (!gameActive) return;

            // DİNAMİK ZORLAŞMA (Dino Modu): Skor arttıkça hızlar küçük oranlarla artar
            let zorlukCarpan = 1 + (skor / 15000); 
            let mevcutNormalHiz = gemi.baseNormalHiz * zorlukCarpan;
            let mevcutTurboHiz = gemi.baseTurboHiz * zorlukCarpan;

            if (keys['KeyA']) gemi.aci -= gemi.donusHizi; // Eksen dönme hızı sabit
            if (keys['KeyD']) gemi.aci += gemi.donusHizi;
            
            let hiz = 0;
            if (keys['KeyW']) hiz = keys['ShiftLeft'] ? mevcutTurboHiz : mevcutNormalHiz;
            else if (keys['KeyS']) hiz = -0.9 * zorlukCarpan;

            gemi.x += Math.cos(gemi.aci) * hiz;
            gemi.y += Math.sin(gemi.aci) * hiz;

            gemi.x = Math.max(30, Math.min(canvas.width - 30, gemi.x));
            gemi.y = Math.max(30, Math.min(canvas.height - 30, gemi.y));

            if (keys['Space'] && !gemi.ateslendi) {
                fire('normal');
                gemi.ateslendi = true;
                setTimeout(() => gemi.ateslendi = false, 280); 
            }
            if (keys['KeyF'] && lazerSarj >= 100) { fire('lazer'); lazerSarj = 0; }
            if (lazerSarj < 100) lazerSarj += 0.15;

            document.getElementById('skor').innerText = skor;
            document.getElementById('zirh').innerText = `%${Math.floor(zirh)}`;
            document.getElementById('lazerSarj').innerText = `%${Math.floor(lazerSarj)}`;

            saglikCantalar.forEach((s, si) => {
                if (Math.hypot(gemi.x - s.x, gemi.y - s.y) < 40) {
                    zirh = Math.min(80, zirh + 30);
                    saglikCantalar.splice(si, 1);
                }
            });

            puanlar.forEach((p, pi) => {
                let dist = Math.hypot(gemi.x - p.x, gemi.y - p.y);
                if (dist < 150) {
                    p.x += (gemi.x - p.x) / dist * 3;
                    p.y += (gemi.y - p.y) / dist * 3;
                }
                if (dist < 30) { skor += 100; puanlar.splice(pi, 1); }
            });

            mermiler.forEach((m, mi) => {
                m.x += m.vx; m.y += m.vy;
                if(m.x < 0 || m.x > canvas.width || m.y < 0 || m.y > canvas.height) mermiler.splice(mi, 1);
            });

            dusmanlar.forEach((d, di) => {
                let dist = Math.hypot(gemi.x - d.x, gemi.y - d.y);
                // Düşman hızı da skora göre zorlaşır
                d.x += (gemi.x - d.x) / dist * (0.42 * zorlukCarpan);
                d.y += (gemi.y - d.y) / dist * (0.42 * zorlukCarpan);

                if(dist < 35) {
                    zirh -= 0.1; 
                    if(zirh <= 0) gameOver();
                }

                mermiler.forEach((m, mi) => {
                    if(Math.hypot(m.x - d.x, m.y - d.y) < 25) {
                        puanlar.push({x: d.x, y: d.y});
                        dusmanlar.splice(di, 1);
                        if(m.type !== 'lazer') mermiler.splice(mi, 1);
                        skor += 10;
                    }
                });
            });
        }

        function fire(type) {
            playGunSound(); // Ateş edildiğinde sesi tetikle
            mermiler.push({
                x: gemi.x, y: gemi.y,
                vx: Math.cos(gemi.aci) * (type === 'lazer' ? 10 : 6),
                vy: Math.sin(gemi.aci) * (type === 'lazer' ? 10 : 6),
                type: type
            });
        }

        let menuAnim = 0;
        function draw() {
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (gameActive) {
                gemi.draw();
                saglikCantalar.forEach(s => {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(s.x-12, s.y-12, 24, 24);
                    ctx.fillStyle = '#f00';
                    ctx.fillRect(s.x-10, s.y-3, 20, 6);
                    ctx.fillRect(s.x-3, s.y-10, 6, 20);
                });
                mermiler.forEach(m => {
                    ctx.fillStyle = m.type === 'lazer' ? '#0ff' : '#ff0';
                    ctx.beginPath(); ctx.arc(m.x, m.y, 4, 0, Math.PI*2); ctx.fill();
                });
                dusmanlar.forEach(d => {
                    ctx.strokeStyle = '#f44'; ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.arc(d.x, d.y, 20, 0, Math.PI*2); ctx.stroke();
                });
                puanlar.forEach(p => {
                    ctx.fillStyle = '#0f0';
                    ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
                });
            } else {
                menuAnim += 0.04;
                ctx.save();
                ctx.translate(canvas.width * 0.8, canvas.height * 0.3);
                gemi.aci += 0.005;
                gemi.draw(3 + Math.sin(menuAnim) * 0.2);
                ctx.restore();
            }
        }

        function spawnEnemy() { if(dusmanlar.length < 12) dusmanlar.push({x: Math.random()*canvas.width, y: -50}); }
        function spawnSaglik() { if (zirh < 80 && saglikCantalar.length < 2) saglikCantalar.push({x: Math.random() * (canvas.width - 100) + 50, y: Math.random() * (canvas.height - 100) + 50}); }

        function startNewGame() {
            gameActive = true; skor = 0; zirh = 100;
            dusmanlar = []; mermiler = []; puanlar = []; saglikCantalar = [];
            startScreen.style.display = 'none';
            document.getElementById('gameUI').style.display = 'block';
        }

        function gameOver() {
            gameActive = false;
            lastScore = skor;
            if(skor > highScore) highScore = skor;
            localStorage.setItem('highScore', highScore);
            localStorage.setItem('lastScore', lastScore);
            document.getElementById('highScoreText').innerText = highScore;
            document.getElementById('lastScoreText').innerText = lastScore;
            startScreen.style.display = 'flex';
            document.getElementById('gameUI').style.display = 'none';
        }

        startButton.addEventListener('click', startNewGame);
        // Düşman sıklığı 3000ms'e çekildi
        setInterval(() => { if(gameActive) { spawnEnemy(); spawnSaglik(); } }, 3000);
        function loop() { update(); draw(); requestAnimationFrame(loop); }
        loop();
        window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
    </script>
</body>
</html>
