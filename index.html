<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Starship Defender - Re-Calibrated Edition</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Courier New', monospace; color: #00ffcc; }
        canvas { display: block; }
        
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column;
            justify-content: flex-start; align-items: flex-start;
            padding-left: 10%; padding-top: 10vh; z-index: 100;
        }

        .btn {
            padding: 15px 30px; width: 450px; font-size: 24px; background: transparent;
            color: #00ffcc; border: 3px solid #00ffcc; cursor: pointer;
            transition: 0.3s; margin-bottom: 15px; text-transform: uppercase; font-weight: bold;
            text-align: center; font-family: 'Courier New', monospace;
        }
        .btn:hover { background: #00ffcc; color: #000; box-shadow: 0 0 20px #00ffcc; }

        .btn-settings { 
            width: 315px; font-size: 18px; 
            border: 2px solid rgba(0, 255, 204, 0.5); 
            background: rgba(0, 40, 40, 0.3); 
            color: #fff;
        }

        .score-box {
            padding: 12px 25px; width: 315px; font-size: 18px; color: #fff;
            border: 2px solid rgba(0, 255, 204, 0.5); margin-bottom: 10px;
            text-align: center; background: rgba(0, 40, 40, 0.3); font-weight: bold; box-sizing: border-box;
        }

        #settingsScreen, #pauseScreen { 
            display: none; align-items: center; padding-left: 0; justify-content: center; 
        }
        .setting-item { margin: 10px 0; text-align: center; }
        input[type=range] { width: 300px; accent-color: #00ffcc; }

        #pauseBtnUI {
            position: absolute; top: 20px; left: 20px; width: 150px; padding: 10px;
            background: rgba(0, 40, 40, 0.8); color: #00ffcc; border: 2px solid #00ffcc;
            cursor: pointer; font-weight: bold; display: none; z-index: 110;
        }
        #gameUI {
            position: absolute; top: 70px; left: 20px; background: rgba(0, 40, 40, 0.85);
            padding: 15px; border: 2px solid #00ffcc; border-radius: 8px; display: none;
        }
    </style>
</head>
<body>

    <div id="startScreen" class="screen">
        <button class="btn" onclick="startNewGame()">YENİ OYUNA BAŞLA</button>
        <div class="score-box">EN İYİ SKOR: <span id="highScoreText">0</span></div>
        <div class="score-box">EN SON SKOR: <span id="lastScoreText">0</span></div>
        <button class="btn btn-settings" onclick="toggleSettings(true)">KONTROL AYARLARI</button>
    </div>

    <div id="pauseScreen" class="screen">
        <h1 style="color:#00ffcc">OYUN DURDURULDU</h1>
        <button class="btn" onclick="resumeGame()">DEVAM ET</button>
        <button class="btn" onclick="toggleSettings(true, true)">AYARLAR</button>
        <button class="btn" onclick="goToMainMenu()">ANA MENÜ</button>
    </div>

    <div id="settingsScreen" class="screen">
        <h2 style="color:#00ffcc">KONTROL PANELİ (RE-KALİBRE)</h2>
        <div class="setting-item"><label>EKSEN HASSASİYETİ: <span id="val_donus">0.08</span></label><br><input type="range" id="inp_donus" min="0.01" max="0.16" step="0.001" value="0.08"></div>
        <div class="setting-item"><label>GEMİ HIZI: <span id="val_hiz">4.0</span></label><br><input type="range" id="inp_hiz" min="1.0" max="8.0" step="0.1" value="4.0"></div>
        <div class="setting-item"><label>DÜŞMAN SIKLIĞI (Saniye): <span id="val_siklik">1.0</span></label><br><input type="range" id="inp_siklik" min="0.2" max="4.0" step="0.1" value="1.0"></div>
        <div class="setting-item"><label>DÜŞMAN HIZI: <span id="val_dusmanHiz">2.0</span></label><br><input type="range" id="inp_dusmanHiz" min="0.5" max="4.0" step="0.05" value="2.0"></div>
        <div class="setting-item"><label>SES SEVİYESİ: <span id="val_ses">100</span>%</label><br><input type="range" id="inp_ses" min="0" max="100" step="1" value="100"></div>
        <button class="btn btn-settings" style="margin-top:20px" onclick="closeSettings()">KAYDET VE DÖN</button>
    </div>

    <button id="pauseBtnUI" onclick="togglePause()">DURDUR (ESC)</button>

    <div id="gameUI">
        <div style="color: #00ffcc; border-bottom: 1px solid #00ffcc; margin-bottom: 5px;">KAPTAN MİKAİL</div>
        <div>SKOR: <span id="skor" style="color: #fff;">0</span></div>
        <div>CAN SEVİYESİ: <span id="zirh" style="color: #0f0;">%100</span></div>
    </div>

    <canvas id="game"></canvas>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let gameActive = false, isPaused = false, skor = 0, zirh = 100;
        let settingsFromPause = false;
        const keys = {};
        let mermiler = [], dusmanlar = [], puanlar = [], saglikCantalar = [], enemyInterval;

        // YENİ KALİBRE EDİLMİŞ VARSAYILANLAR
        let settings = JSON.parse(localStorage.getItem('userSettings')) || {
            donus: 0.08, hiz: 4.0, siklik: 1.0, dusmanHiz: 2.0, ses: 1.0
        };

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(freq, type, decay, volMult = 1, expEnd = 0.01) {
            if(settings.ses === 0) return;
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(expEnd, audioCtx.currentTime + decay);
            gain.gain.setValueAtTime(settings.ses * volMult, audioCtx.currentTime);
            gain.connect(audioCtx.destination);
            osc.connect(gain);
            osc.start(); osc.stop(audioCtx.currentTime + decay);
        }

        const gemi = {
            x: canvas.width / 2, y: canvas.height / 2, aci: 0,
            draw(scale = 1, customZirh = null, customAci = null, isBright = false) {
                let displayZirh = customZirh !== null ? customZirh : zirh;
                let displayAci = customAci !== null ? customAci : this.aci;
                ctx.save(); ctx.translate(this.x, this.y); ctx.scale(scale, scale);
                ctx.beginPath(); ctx.arc(0, 0, 22, 0, Math.PI * 2);
                ctx.strokeStyle = isBright ? '#fff' : '#aaa'; ctx.lineWidth = 2; ctx.stroke();
                let k = Math.ceil((displayZirh / 100) * 15);
                ctx.save(); ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI * 2); ctx.clip();
                ctx.fillStyle = `hsl(${(k/15)*120}, 100%, ${isBright ? '55%' : '40%'})`;
                if(isBright) { ctx.shadowBlur = 20; ctx.shadowColor = ctx.fillStyle; }
                ctx.fillRect(-22, 22 - ((k/15)*44), 44, 44); ctx.restore();
                ctx.rotate(displayAci);
                ctx.beginPath(); ctx.moveTo(34, 0); ctx.lineTo(54, 0); ctx.lineTo(44, 8); ctx.lineTo(44, -8); ctx.lineTo(54, 0);
                ctx.fillStyle = isBright ? '#00ffcc' : '#00aa88'; ctx.fill(); 
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.stroke();
                ctx.restore();
            }
        };

        function spawnEnemy() {
            if(!gameActive || isPaused) return;
            const side = Math.floor(Math.random() * 4);
            let x, y;
            if(side === 0) { x = Math.random()*canvas.width; y = -50; }
            else if(side === 1) { x = canvas.width+50; y = Math.random()*canvas.height; }
            else if(side === 2) { x = Math.random()*canvas.width; y = canvas.height+50; }
            else { x = -50; y = Math.random()*canvas.height; }
            dusmanlar.push({x, y});
        }

        function update() {
            if (!gameActive || isPaused) return;
            let zorluk = 1 + (skor / 20000);
            if (keys['KeyA']) gemi.aci -= settings.donus;
            if (keys['KeyD']) gemi.aci += settings.donus;
            let v = 0;
            if (keys['KeyW']) v = keys['ShiftLeft'] ? settings.hiz * 1.8 * zorluk : settings.hiz * zorluk;
            else if (keys['KeyS']) v = -settings.hiz * 0.8;
            gemi.x += Math.cos(gemi.aci) * v; gemi.y += Math.sin(gemi.aci) * v;
            gemi.x = Math.max(30, Math.min(canvas.width - 30, gemi.x));
            gemi.y = Math.max(30, Math.min(canvas.height - 30, gemi.y));

            if (keys['Space'] && !gemi.fireLock) {
                playSound(180, 'triangle', 0.12, 0.8, 0.05); 
                mermiler.push({x: gemi.x, y: gemi.y, vx: Math.cos(gemi.aci)*20, vy: Math.sin(gemi.aci)*20});
                gemi.fireLock = true; setTimeout(() => gemi.fireLock = false, 120);
            }

            dusmanlar.forEach((d, i) => {
                let dist = Math.hypot(gemi.x - d.x, gemi.y - d.y);
                d.x += (gemi.x - d.x)/dist * (settings.dusmanHiz * zorluk);
                d.y += (gemi.y - d.y)/dist * (settings.dusmanHiz * zorluk);
                if(dist < 35) { zirh -= 0.15; if(zirh <= 0) gameOver(); }
                mermiler.forEach((m, mi) => {
                    if(Math.hypot(m.x - d.x, m.y - d.y) < 25) {
                        playSound(3500, 'sine', 0.05, 0.4, 100); 
                        puanlar.push({x: d.x, y: d.y});
                        dusmanlar.splice(i, 1); mermiler.splice(mi, 1); skor += 10;
                    }
                });
            });

            puanlar.forEach((p, i) => {
                let d = Math.hypot(gemi.x - p.x, gemi.y - p.y);
                if(d < 200) { p.x += (gemi.x-p.x)/d*10; p.y += (gemi.y-p.y)/d*10; }
                if(d < 30) { skor += 100; puanlar.splice(i, 1); }
            });

            saglikCantalar.forEach((s, i) => {
                if(Math.hypot(gemi.x - s.x, gemi.y - s.y) < 40) {
                    zirh = Math.min(100, zirh + 30);
                    saglikCantalar.splice(i, 1);
                }
            });

            mermiler.forEach((m, i) => { m.x += m.vx; m.y += m.vy; if(m.x<0||m.x>canvas.width||m.y<0||m.y>canvas.height) mermiler.splice(i, 1); });
            document.getElementById('skor').innerText = skor;
            document.getElementById('zirh').innerText = `%${Math.floor(zirh)}`;
        }

        let menuAnimZirh = 100, menuAnimDir = -0.8, menuAci = 0;
        function draw() {
            ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.fillRect(0,0,canvas.width,canvas.height);
            if(gameActive) {
                gemi.draw(1, null, null, true);
                mermiler.forEach(m => { ctx.fillStyle='#ff0'; ctx.beginPath(); ctx.arc(m.x,m.y,4,0,Math.PI*2); ctx.fill(); });
                dusmanlar.forEach(d => { ctx.strokeStyle='#f44'; ctx.beginPath(); ctx.arc(d.x,d.y,20,0,Math.PI*2); ctx.stroke(); });
                puanlar.forEach(p => { ctx.fillStyle='#0f0'; ctx.shadowBlur = 10; ctx.shadowColor = '#0f0'; ctx.beginPath(); ctx.arc(p.x,p.y,4,0,Math.PI*2); ctx.fill(); ctx.shadowBlur = 0; });
                saglikCantalar.forEach(s => { ctx.fillStyle='#fff'; ctx.fillRect(s.x-10,s.y-10,20,20); ctx.fillStyle='#f00'; ctx.fillRect(s.x-8,s.y-2,16,4); ctx.fillRect(s.x-2,s.y-8,4,16); });
            } else {
                menuAnimZirh += menuAnimDir;
                if(menuAnimZirh <= 10 || menuAnimZirh >= 100) menuAnimDir *= -1;
                menuAci += (Math.PI * 2) / (60 * 2.5);
                ctx.save(); ctx.translate(canvas.width*0.75, canvas.height*0.35);
                gemi.x = 0; gemi.y = 0;
                gemi.draw(3.5, menuAnimZirh, menuAci, true); ctx.restore();
            }
        }

        function togglePause() { 
            if(!gameActive) return; 
            isPaused = !isPaused; 
            document.getElementById('pauseScreen').style.display = isPaused ? 'flex' : 'none'; 
        }
        function resumeGame() { isPaused = false; document.getElementById('pauseScreen').style.display = 'none'; }
        function goToMainMenu() { location.reload(); }

        function startNewGame() {
            gameActive = true; isPaused = false; skor = 0; zirh = 100;
            dusmanlar = []; mermiler = []; puanlar = []; saglikCantalar = [];
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameUI').style.display = 'block';
            document.getElementById('pauseBtnUI').style.display = 'block';
            if(enemyInterval) clearInterval(enemyInterval);
            enemyInterval = setInterval(() => {
                if(gameActive && !isPaused) {
                    spawnEnemy();
                    if(zirh < 65 && saglikCantalar.length < 2) saglikCantalar.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height});
                }
            }, settings.siklik * 1000);
        }

        function toggleSettings(show, fromPause = false) {
            settingsFromPause = fromPause;
            document.getElementById(fromPause ? 'pauseScreen' : 'startScreen').style.display = show ? 'none' : 'flex';
            document.getElementById('settingsScreen').style.display = show ? 'flex' : 'none';
        }
        function closeSettings() { toggleSettings(false, settingsFromPause); }

        function updateSettingsUI() {
            ['donus', 'hiz', 'siklik', 'dusmanHiz', 'ses'].forEach(id => {
                let inp = document.getElementById('inp_'+id);
                let valDisp = document.getElementById('val_'+id);
                inp.value = id === 'ses' ? settings[id]*100 : settings[id];
                valDisp.innerText = id === 'ses' ? Math.round(settings[id]*100) : settings[id];
                inp.oninput = (e) => {
                    let v = parseFloat(e.target.value);
                    settings[id] = id === 'ses' ? v/100 : v;
                    valDisp.innerText = v;
                    localStorage.setItem('userSettings', JSON.stringify(settings));
                };
            });
        }

        window.addEventListener('keydown', e => { keys[e.code] = true; if(e.code === 'Escape') togglePause(); });
        window.addEventListener('keyup', e => keys[e.code] = false);
        function loop() { update(); draw(); requestAnimationFrame(loop); }
        updateSettingsUI();
        document.getElementById('highScoreText').innerText = localStorage.getItem('highScore') || 0;
        document.getElementById('lastScoreText').innerText = localStorage.getItem('lastScore') || 0;
        loop();
        window.onresize = () => { canvas.width=window.innerWidth; canvas.height=window.innerHeight; };
    </script>
</body>
</html>
